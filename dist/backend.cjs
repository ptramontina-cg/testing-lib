"use strict";var G=Object.create;var M=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var z=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var $=(a,e)=>{for(var t in e)M(a,t,{get:e[t],enumerable:!0})},A=(a,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of W(e))!k.call(a,i)&&i!==t&&M(a,i,{get:()=>e[i],enumerable:!(r=X(e,i))||r.enumerable});return a};var p=(a,e,t)=>(t=a!=null?G(z(a)):{},A(e||!a||!a.__esModule?M(t,"default",{value:a,enumerable:!0}):t,a)),U=a=>A(M({},"__esModule",{value:!0}),a);var H={};$(H,{CreativeValidator:()=>v});module.exports=U(H);var V=["JPEG","JPG","PNG","GIF"];var n=class extends Error{code;constructor(e,t){super(e),this.code=t,this.name="ValidationError"}get errorCode(){return this.code}};var f=p(require("fluent-ffmpeg"),1),b=p(require("stream-buffers"),1),m=require("fs"),c=p(require("path"),1),d=class{constructor(){process&&process.platform==="win32"&&(f.default.setFfmpegPath("C:/ffmpeg-master-latest-win64-gpl/bin/ffmpeg.exe"),f.default.setFfprobePath("C:/ffmpeg-master-latest-win64-gpl/bin/ffprobe.exe"))}getResolutionQuality(e,t){return e>=3840&&t>=2160?"4K":e>=2048&&t>=1080?"2K":e>=1920&&t>=1080?"Full HD":e>=1280&&t>=720?"HD":"SD"}async generateThumbnail(e){return await new Promise(async(t,r)=>{let i=c.default.join(__dirname,"tmp"),s=c.default.join(i,`temp_${Date.now()}`),l=c.default.join(i,`screenshot_${Date.now()}.png`);await m.promises.mkdir(i,{recursive:!0}),await m.promises.writeFile(s,e.buffer),(0,f.default)(s).on("error",async o=>{console.error("Error generating screenshot:",o),r(o)}).on("end",async()=>{try{let o=await m.promises.readFile(l);await m.promises.unlink(s).catch(()=>{}),await m.promises.unlink(l).catch(()=>{}),t(o)}catch(o){r(o)}}).screenshots({timestamps:["50%"],filename:c.default.basename(l),folder:i})})}async analyzeMediaBuffer(e){return new Promise((t,r)=>{let i=new b.default.ReadableStreamBuffer({frequency:10,chunkSize:2048});i.put(e.buffer),i.stop(),(0,f.default)(i).ffprobe(async(s,l)=>{if(s){r(s);return}let o=l.streams.find(I=>I.codec_type==="video"||I.codec_type==="image");if(!o){r(new Error("No video or image stream found"));return}let u={type:o.codec_type+"",resolution:{width:o.width,height:o.height},format:l.format.format_name+""};if(e.mimetype.startsWith("video")){u.durationInSeconds=o.duration?Math.floor(parseFloat(o.duration)):void 0,u.bitRate=Math.floor(parseInt(o.bit_rate+"")/1024),u.resolution.quality=this.getResolutionQuality(parseInt(o.width+""),parseInt(o.height+""));let I=await this.generateThumbnail(e);u.thumbnail=I}t(u)})})}};var E=class{async validate(e){let t=await this.getImageMetadata(e),r=[this.validateResolution(t.resolution.height,t.resolution.width),this.validateSize(e.size),this.validateFormat(e.mimetype)].filter(i=>i);if(r.length)throw new n(`Invalid Image: ${r.join(", ")}`,100);return!0}validateResolution(e,t){return t>2e3||t<50||e>2e3||e<50?`Invalid resolution. Min: ${50}x${50}. Max: ${2e3}x${2e3}.`:!1}validateSize(e){return e>1e8?`Invalid size. Maximum allowed is: ${1e8/1e6} MB.`:!1}validateFormat(e){return V.includes(e)?!1:`Invalid format. Only the following are allowed: ${V.join(", ")}.`}async getImageMetadata(e){return await new d().analyzeMediaBuffer(e)}};var L=p(require("xml2js"),1),x=p(require("axios"),1);var g=class{async validate(e){let t=await this.downloadFileFromUrl(e),r=this.validateXml(await this.parseXml(t));if(r)throw new n("VAST is not valid: "+r,102);return!0}validateXml(e){if(!e.VAST)return"XML is missing mandatory element - VAST";let t=e.VAST?.Ad||[];if(!t.length)return"XML is missing mandatory element - Ad";for(let r of t)if(!r.InLine&&!r.Wrapper)return"XML is missing mandatory element - Inline or wrapper";return!1}async parseXml(e){let t=await L.parseStringPromise(e);if(!t)throw new n("VAST is not valid: XML Structure Could not be parsed",102);return t}async downloadFileFromUrl(e){try{let t=await x.default.get(e);if(!(t?.headers?.["content-type"]).includes("xml"))throw new Error("The provided URL does not return a valid file type.");return t.data}catch(t){throw new n(`VAST is not valid: ${t??"Failed to download the file from the provided URL."}`,203)}}};var P=[432,720,1080,1280,2160],R=["3G2","3GP","3GPP","3GPP2","ASF","AVI","X-MSVIDEO","MP2T","F4A","F4B","F4P","F4V","FLV","X-FLV","M2V","M4V","MKV","X-MATROSKA","MOV","M4P","MPE","MPEG","MP2","MP4","MPG","MPV","OGG","OGV","QT","QUICKTIME","RM","SWF","TS","VOB","WEBM","WMV","X-MS-WMV"],N=[15,30,60],w={2160:3e4,1280:13e3,1080:12e3,720:8e3,432:2e3};var _=1e8;function B(a){return(a.includes("/")?a.split("/")[1]:a).toUpperCase()}var h=class{async validate(e){let r=await new d().analyzeMediaBuffer(e),i=[this.validateFormat(r.format.split(",")),this.validateDuration(r.durationInSeconds??0),this.validateResolution(r.resolution.height),this.validateSize(e.size),this.validateBitRate(r.bitRate??0,r.resolution?.height)].filter(s=>s);if(i.length)throw new n(`Invalid Video: ${i.join(", ")}`,101);return!1}validateFormat(e){for(let t of e)if(R.includes(B(t)))return!1;return"Incorrect file format. Use MP4, FLV, or AVI instead."}validateSize(e){return e>_?`Invalid size - Maximum allowed is: ${_/1e6} MB.`:!1}validateDuration(e){return N.includes(e)?!1:`The uploaded video has duration ${e}sec which is not supported - Please use one of the following durations: 15s, 30s, 60s`}validateResolution(e){return P.includes(e??0)?!1:"Resolution not supported - Please use 2160p, 1280p, 1080p, 720p or 432p"}validateBitRate(e,t){if(!(t in w))return"Invalid bitrate - Didn't match with resolution.";let r=w[t];return e>=r?!1:`Video has a bitrate of ${e} kbps which is incorrect for ${t}p resolution - Please the following or above: ${r}.
   `}};var v=class{async validate(e,t){if(t instanceof String&&e!=="vast")throw new Error("Invalid type for backend validation.");switch(e){case"image":return await this.validateImage(t);case"video":return await this.validateVideo(t);case"vast":return await this.validateVast(t)}}async validateVideo(e){return await new h().validate(e)}async validateImage(e){return await new E().validate(e)}async validateVast(e){return await new g().validate(e)}};0&&(module.exports={CreativeValidator});
