(function(R,z){typeof exports=="object"&&typeof module<"u"?z(exports):typeof define=="function"&&define.amd?define(["exports"],z):(R=typeof globalThis<"u"?globalThis:R||self,z(R["creative-validator"]={}))})(this,function(R){"use strict";var Pt=Object.defineProperty;var Tt=(R,z,q)=>z in R?Pt(R,z,{enumerable:!0,configurable:!0,writable:!0,value:q}):R[z]=q;var k=(R,z,q)=>Tt(R,typeof z!="symbol"?z+"":z,q);function z(A,e){for(var t=0;t<e.length;t++){const y=e[t];if(typeof y!="string"&&!Array.isArray(y)){for(const f in y)if(f!=="default"&&!(f in A)){const n=Object.getOwnPropertyDescriptor(y,f);n&&Object.defineProperty(A,f,n.get?n:{enumerable:!0,get:()=>y[f]})}}}return Object.freeze(Object.defineProperty(A,Symbol.toStringTag,{value:"Module"}))}class q{constructor(e){this.file=e}async validate(){return console.log(this.file),!0}}class Be{constructor(e){this.url=e}async validate(){return console.log(this.url),!0}}var $e=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function je(A){return A&&A.__esModule&&Object.prototype.hasOwnProperty.call(A,"default")?A.default:A}function He(A){if(A.__esModule)return A;var e=A.default;if(typeof e=="function"){var t=function y(){return this instanceof y?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(A).forEach(function(y){var f=Object.getOwnPropertyDescriptor(A,y);Object.defineProperty(t,y,f.get?f:{enumerable:!0,get:function(){return A[y]}})}),t}const V=He(Object.freeze(Object.defineProperty({__proto__:null,default:{}},Symbol.toStringTag,{value:"Module"})));var $={exports:{}},j,pe;function Ue(){if(pe)return j;pe=1,j=y,y.sync=f;var A=V;function e(n,h){var u=h.pathExt!==void 0?h.pathExt:process.env.PATHEXT;if(!u||(u=u.split(";"),u.indexOf("")!==-1))return!0;for(var i=0;i<u.length;i++){var c=u[i].toLowerCase();if(c&&n.substr(-c.length).toLowerCase()===c)return!0}return!1}function t(n,h,u){return!n.isSymbolicLink()&&!n.isFile()?!1:e(h,u)}function y(n,h,u){A.stat(n,function(i,c){u(i,i?!1:t(c,n,h))})}function f(n,h){return t(A.statSync(n),n,h)}return j}var H,de;function We(){if(de)return H;de=1,H=e,e.sync=t;var A=V;function e(n,h,u){A.stat(n,function(i,c){u(i,i?!1:y(c,h))})}function t(n,h){return y(A.statSync(n),h)}function y(n,h){return n.isFile()&&f(n,h)}function f(n,h){var u=n.mode,i=n.uid,c=n.gid,a=h.uid!==void 0?h.uid:process.getuid&&process.getuid(),d=h.gid!==void 0?h.gid:process.getgid&&process.getgid(),v=parseInt("100",8),S=parseInt("010",8),F=parseInt("001",8),_=v|S,m=u&F||u&S&&c===d||u&v&&i===a||u&_&&a===0;return m}return H}var U,ve;function Ge(){if(ve)return U;ve=1;var A;process.platform==="win32"||$e.TESTING_WINDOWS?A=Ue():A=We(),U=e,e.sync=t;function e(y,f,n){if(typeof f=="function"&&(n=f,f={}),!n){if(typeof Promise!="function")throw new TypeError("callback not provided");return new Promise(function(h,u){e(y,f||{},function(i,c){i?u(i):h(c)})})}A(y,f||{},function(h,u){h&&(h.code==="EACCES"||f&&f.ignoreErrors)&&(h=null,u=!1),n(h,u)})}function t(y,f){try{return A.sync(y,f||{})}catch(n){if(f&&f.ignoreErrors||n.code==="EACCES")return!1;throw n}}return U}var W,me;function Xe(){if(me)return W;me=1,W=h,h.sync=u;var A=process.platform==="win32"||process.env.OSTYPE==="cygwin"||process.env.OSTYPE==="msys",e=V,t=A?";":":",y=Ge();function f(i){var c=new Error("not found: "+i);return c.code="ENOENT",c}function n(i,c){var a=c.colon||t,d=c.path||process.env.PATH||"",v=[""];d=d.split(a);var S="";return A&&(d.unshift(process.cwd()),S=c.pathExt||process.env.PATHEXT||".EXE;.CMD;.BAT;.COM",v=S.split(a),i.indexOf(".")!==-1&&v[0]!==""&&v.unshift("")),(i.match(/\//)||A&&i.match(/\\/))&&(d=[""]),{env:d,ext:v,extExe:S}}function h(i,c,a){typeof c=="function"&&(a=c,c={});var d=n(i,c),v=d.env,S=d.ext,F=d.extExe,_=[];(function m(b,O){if(b===O)return c.all&&_.length?a(null,_):a(f(i));var x=v[b];x.charAt(0)==='"'&&x.slice(-1)==='"'&&(x=x.slice(1,-1));var E=e.join(x,i);!x&&/^\.[\\\/]/.test(i)&&(E=i.slice(0,2)+E),function g(r,s){if(r===s)return m(b+1,O);var o=S[r];y(E+o,{pathExt:F},function(l,p){if(!l&&p)if(c.all)_.push(E+o);else return a(null,E+o);return g(r+1,s)})}(0,S.length)})(0,v.length)}function u(i,c){c=c||{};for(var a=n(i,c),d=a.env,v=a.ext,S=a.extExe,F=[],_=0,m=d.length;_<m;_++){var b=d[_];b.charAt(0)==='"'&&b.slice(-1)==='"'&&(b=b.slice(1,-1));var O=e.join(b,i);!b&&/^\.[\\\/]/.test(i)&&(O=i.slice(0,2)+O);for(var x=0,E=v.length;x<E;x++){var g=O+v[x],r;try{if(r=y.sync(g,{pathExt:S}),r)if(c.all)F.push(g);else return g}catch{}}}if(c.all&&F.length)return F;if(c.nothrow)return null;throw f(i)}return W}var ge;function M(){if(ge)return $.exports;ge=1,V.exec;var A=V.platform().match(/win(32|64)/),e=Xe(),t=/\r\n|\r|\n/g,y=/^\[?(.*?)\]?$/,f=/[,]/,n={};function h(i){var c={};i=i.replace(/=\s+/g,"=").trim();for(var a=i.split(" "),d=0;d<a.length;d++){var v=a[d].split("=",2),S=v[0],F=v[1];if(typeof F>"u")return null;c[S]=F}return c}var u=$.exports={isWindows:A,streamRegexp:y,copy:function(i,c){Object.keys(i).forEach(function(a){c[a]=i[a]})},args:function(){var i=[],c=function(){arguments.length===1&&Array.isArray(arguments[0])?i=i.concat(arguments[0]):i=i.concat([].slice.call(arguments))};return c.clear=function(){i=[]},c.get=function(){return i},c.find=function(a,d){var v=i.indexOf(a);if(v!==-1)return i.slice(v+1,v+1+(d||0))},c.remove=function(a,d){var v=i.indexOf(a);v!==-1&&i.splice(v,(d||0)+1)},c.clone=function(){var a=u.args();return a(i),a},c},makeFilterStrings:function(i){return i.map(function(c){if(typeof c=="string")return c;var a="";return Array.isArray(c.inputs)?a+=c.inputs.map(function(d){return d.replace(y,"[$1]")}).join(""):typeof c.inputs=="string"&&(a+=c.inputs.replace(y,"[$1]")),a+=c.filter,c.options&&(typeof c.options=="string"||typeof c.options=="number"?a+="="+c.options:Array.isArray(c.options)?a+="="+c.options.map(function(d){return typeof d=="string"&&d.match(f)?"'"+d+"'":d}).join(":"):Object.keys(c.options).length&&(a+="="+Object.keys(c.options).map(function(d){var v=c.options[d];return typeof v=="string"&&v.match(f)&&(v="'"+v+"'"),d+"="+v}).join(":"))),Array.isArray(c.outputs)?a+=c.outputs.map(function(d){return d.replace(y,"[$1]")}).join(""):typeof c.outputs=="string"&&(a+=c.outputs.replace(y,"[$1]")),a})},which:function(i,c){if(i in n)return c(null,n[i]);e(i,function(a,d){if(a)return c(null,n[i]="");c(null,n[i]=d)})},timemarkToSeconds:function(i){if(typeof i=="number")return i;if(i.indexOf(":")===-1&&i.indexOf(".")>=0)return Number(i);var c=i.split(":"),a=Number(c.pop());return c.length&&(a+=Number(c.pop())*60),c.length&&(a+=Number(c.pop())*3600),a},extractCodecData:function(i,c,a){var d=/Input #[0-9]+, ([^ ]+),/,v=/Duration\: ([^,]+)/,S=/Audio\: (.*)/,F=/Video\: (.*)/;"inputStack"in a||(a.inputStack=[],a.inputIndex=-1,a.inInput=!1);var _=a.inputStack,m=a.inputIndex,b=a.inInput,O,x,E,g;if(O=c.match(d))b=a.inInput=!0,m=a.inputIndex=a.inputIndex+1,_[m]={format:O[1],audio:"",video:"",duration:""};else if(b&&(x=c.match(v)))_[m].duration=x[1];else if(b&&(E=c.match(S)))E=E[1].split(", "),_[m].audio=E[0],_[m].audio_details=E;else if(b&&(g=c.match(F)))g=g[1].split(", "),_[m].video=g[0],_[m].video_details=g;else if(/Output #\d+/.test(c))b=a.inInput=!1;else if(/Stream mapping:|Press (\[q\]|ctrl-c) to stop/.test(c))return i.emit.apply(i,["codecData"].concat(_)),!0;return!1},extractProgress:function(i,c){var a=h(c);if(a){var d={frames:parseInt(a.frame,10),currentFps:parseInt(a.fps,10),currentKbps:a.bitrate?parseFloat(a.bitrate.replace("kbits/s","")):0,targetSize:parseInt(a.size||a.Lsize,10),timemark:a.time};if(i._ffprobeData&&i._ffprobeData.format&&i._ffprobeData.format.duration){var v=Number(i._ffprobeData.format.duration);isNaN(v)||(d.percent=u.timemarkToSeconds(d.timemark)/v*100)}i.emit("progress",d)}},extractError:function(i){return i.split(t).reduce(function(c,a){return a.charAt(0)===" "||a.charAt(0)==="["?[]:(c.push(a),c)},[]).join(`
`)},linesRing:function(i){var c=[],a=[],d=null,v=!1,S=i-1;function F(_){c.forEach(function(m){m(_)})}return{callback:function(_){a.forEach(function(m){_(m)}),c.push(_)},append:function(_){if(!v&&(_ instanceof Buffer&&(_=""+_),!(!_||_.length===0))){var m=_.split(t);m.length===1?d!==null?d=d+m.shift():d=m.shift():(d!==null&&(d=d+m.shift(),F(d),a.push(d)),d=m.pop(),m.forEach(function(b){F(b),a.push(b)}),S>-1&&a.length>S&&a.splice(0,a.length-S))}},get:function(){return d!==null?a.concat([d]).join(`
`):a.join(`
`)},close:function(){v||(d!==null&&(F(d),a.push(d),S>-1&&a.length>S&&a.shift(),d=null),v=!0)}}}};return $.exports}var G,we;function Qe(){if(we)return G;we=1;var A=M();return G=function(e){e.mergeAdd=e.addInput=e.input=function(t){var y=!1,f=!1;if(typeof t!="string"){if(!("readable"in t)||!t.readable)throw new Error("Invalid input");var n=this._inputs.some(function(u){return u.isStream});if(n)throw new Error("Only one input stream is supported");f=!0,t.pause()}else{var h=t.match(/^([a-z]{2,}):/i);y=!h||h[0]==="file"}return this._inputs.push(this._currentInput={source:t,isFile:y,isStream:f,options:A.args()}),this},e.withInputFormat=e.inputFormat=e.fromFormat=function(t){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-f",t),this},e.withInputFps=e.withInputFPS=e.withFpsInput=e.withFPSInput=e.inputFPS=e.inputFps=e.fpsInput=e.FPSInput=function(t){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-r",t),this},e.nativeFramerate=e.withNativeFramerate=e.native=function(){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-re"),this},e.setStartTime=e.seekInput=function(t){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-ss",t),this},e.loop=function(t){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-loop","1"),typeof t<"u"&&this.duration(t),this}},G}var X,ye;function Ze(){if(ye)return X;ye=1;var A=M();return X=function(e){e.withNoAudio=e.noAudio=function(){return this._currentOutput.audio.clear(),this._currentOutput.audioFilters.clear(),this._currentOutput.audio("-an"),this},e.withAudioCodec=e.audioCodec=function(t){return this._currentOutput.audio("-acodec",t),this},e.withAudioBitrate=e.audioBitrate=function(t){return this._currentOutput.audio("-b:a",(""+t).replace(/k?$/,"k")),this},e.withAudioChannels=e.audioChannels=function(t){return this._currentOutput.audio("-ac",t),this},e.withAudioFrequency=e.audioFrequency=function(t){return this._currentOutput.audio("-ar",t),this},e.withAudioQuality=e.audioQuality=function(t){return this._currentOutput.audio("-aq",t),this},e.withAudioFilter=e.withAudioFilters=e.audioFilter=e.audioFilters=function(t){return arguments.length>1&&(t=[].slice.call(arguments)),Array.isArray(t)||(t=[t]),this._currentOutput.audioFilters(A.makeFilterStrings(t)),this}},X}var Q,_e;function Ye(){if(_e)return Q;_e=1;var A=M();return Q=function(e){e.withNoVideo=e.noVideo=function(){return this._currentOutput.video.clear(),this._currentOutput.videoFilters.clear(),this._currentOutput.video("-vn"),this},e.withVideoCodec=e.videoCodec=function(t){return this._currentOutput.video("-vcodec",t),this},e.withVideoBitrate=e.videoBitrate=function(t,y){return t=(""+t).replace(/k?$/,"k"),this._currentOutput.video("-b:v",t),y&&this._currentOutput.video("-maxrate",t,"-minrate",t,"-bufsize","3M"),this},e.withVideoFilter=e.withVideoFilters=e.videoFilter=e.videoFilters=function(t){return arguments.length>1&&(t=[].slice.call(arguments)),Array.isArray(t)||(t=[t]),this._currentOutput.videoFilters(A.makeFilterStrings(t)),this},e.withOutputFps=e.withOutputFPS=e.withFpsOutput=e.withFPSOutput=e.withFps=e.withFPS=e.outputFPS=e.outputFps=e.fpsOutput=e.FPSOutput=e.fps=e.FPS=function(t){return this._currentOutput.video("-r",t),this},e.takeFrames=e.withFrames=e.frames=function(t){return this._currentOutput.video("-vframes",t),this}},Q}var Z,Ee;function Je(){if(Ee)return Z;Ee=1;function A(t,y,f,n){return[{filter:"scale",options:{w:"if(gt(a,"+f+"),"+t+",trunc("+y+"*a/2)*2)",h:"if(lt(a,"+f+"),"+y+",trunc("+t+"/a/2)*2)"}},{filter:"pad",options:{w:t,h:y,x:"if(gt(a,"+f+"),0,("+t+"-iw)/2)",y:"if(lt(a,"+f+"),0,("+y+"-ih)/2)",color:n}}]}function e(t,y,f){var n=t.sizeData=t.sizeData||{};if(n[y]=f,!("size"in n))return[];var h=n.size.match(/([0-9]+)x([0-9]+)/),u=n.size.match(/([0-9]+)x\?/),i=n.size.match(/\?x([0-9]+)/),c=n.size.match(/\b([0-9]{1,3})%/),a,d,v;if(c){var S=Number(c[1])/100;return[{filter:"scale",options:{w:"trunc(iw*"+S+"/2)*2",h:"trunc(ih*"+S+"/2)*2"}}]}else{if(h)return a=Math.round(Number(h[1])/2)*2,d=Math.round(Number(h[2])/2)*2,v=a/d,n.pad?A(a,d,v,n.pad):[{filter:"scale",options:{w:a,h:d}}];if(u||i)return"aspect"in n?(a=u?u[1]:Math.round(Number(i[1])*n.aspect),d=i?i[1]:Math.round(Number(u[1])/n.aspect),a=Math.round(a/2)*2,d=Math.round(d/2)*2,n.pad?A(a,d,n.aspect,n.pad):[{filter:"scale",options:{w:a,h:d}}]):u?[{filter:"scale",options:{w:Math.round(Number(u[1])/2)*2,h:"trunc(ow/a/2)*2"}}]:[{filter:"scale",options:{w:"trunc(oh*a/2)*2",h:Math.round(Number(i[1])/2)*2}}];throw new Error("Invalid size specified: "+n.size)}}return Z=function(t){t.keepPixelAspect=t.keepDisplayAspect=t.keepDisplayAspectRatio=t.keepDAR=function(){return this.videoFilters([{filter:"scale",options:{w:"if(gt(sar,1),iw*sar,iw)",h:"if(lt(sar,1),ih/sar,ih)"}},{filter:"setsar",options:"1"}])},t.withSize=t.setSize=t.size=function(y){var f=e(this._currentOutput,"size",y);return this._currentOutput.sizeFilters.clear(),this._currentOutput.sizeFilters(f),this},t.withAspect=t.withAspectRatio=t.setAspect=t.setAspectRatio=t.aspect=t.aspectRatio=function(y){var f=Number(y);if(isNaN(f)){var n=y.match(/^(\d+):(\d+)$/);if(n)f=Number(n[1])/Number(n[2]);else throw new Error("Invalid aspect ratio: "+y)}var h=e(this._currentOutput,"aspect",f);return this._currentOutput.sizeFilters.clear(),this._currentOutput.sizeFilters(h),this},t.applyAutopadding=t.applyAutoPadding=t.applyAutopad=t.applyAutoPad=t.withAutopadding=t.withAutoPadding=t.withAutopad=t.withAutoPad=t.autoPad=t.autopad=function(y,f){typeof y=="string"&&(f=y,y=!0),typeof y>"u"&&(y=!0);var n=e(this._currentOutput,"pad",y?f||"black":!1);return this._currentOutput.sizeFilters.clear(),this._currentOutput.sizeFilters(n),this}},Z}var Y,Fe;function Ke(){if(Fe)return Y;Fe=1;var A=M();return Y=function(e){e.addOutput=e.output=function(t,y){var f=!1;if(!t&&this._currentOutput)throw new Error("Invalid output");if(t&&typeof t!="string"){if(!("writable"in t)||!t.writable)throw new Error("Invalid output")}else if(typeof t=="string"){var n=t.match(/^([a-z]{2,}):/i);f=!n||n[0]==="file"}if(t&&!("target"in this._currentOutput))this._currentOutput.target=t,this._currentOutput.isFile=f,this._currentOutput.pipeopts=y||{};else{if(t&&typeof t!="string"){var h=this._outputs.some(function(i){return typeof i.target!="string"});if(h)throw new Error("Only one output stream is supported")}this._outputs.push(this._currentOutput={target:t,isFile:f,flags:{},pipeopts:y||{}});var u=this;["audio","audioFilters","video","videoFilters","sizeFilters","options"].forEach(function(i){u._currentOutput[i]=A.args()}),t||delete this._currentOutput.target}return this},e.seekOutput=e.seek=function(t){return this._currentOutput.options("-ss",t),this},e.withDuration=e.setDuration=e.duration=function(t){return this._currentOutput.options("-t",t),this},e.toFormat=e.withOutputFormat=e.outputFormat=e.format=function(t){return this._currentOutput.options("-f",t),this},e.map=function(t){return this._currentOutput.options("-map",t.replace(A.streamRegexp,"[$1]")),this},e.updateFlvMetadata=e.flvmeta=function(){return this._currentOutput.flags.flvmeta=!0,this}},Y}var J,xe;function et(){if(xe)return J;xe=1;var A=M();return J=function(e){e.addInputOption=e.addInputOptions=e.withInputOption=e.withInputOptions=e.inputOption=e.inputOptions=function(t){if(!this._currentInput)throw new Error("No input specified");var y=!0;return arguments.length>1&&(t=[].slice.call(arguments),y=!1),Array.isArray(t)||(t=[t]),this._currentInput.options(t.reduce(function(f,n){var h=String(n).split(" ");return y&&h.length===2?f.push(h[0],h[1]):f.push(n),f},[])),this},e.addOutputOption=e.addOutputOptions=e.addOption=e.addOptions=e.withOutputOption=e.withOutputOptions=e.withOption=e.withOptions=e.outputOption=e.outputOptions=function(t){var y=!0;return arguments.length>1&&(t=[].slice.call(arguments),y=!1),Array.isArray(t)||(t=[t]),this._currentOutput.options(t.reduce(function(f,n){var h=String(n).split(" ");return y&&h.length===2?f.push(h[0],h[1]):f.push(n),f},[])),this},e.filterGraph=e.complexFilter=function(t,y){if(this._complexFilters.clear(),Array.isArray(t)||(t=[t]),this._complexFilters("-filter_complex",A.makeFilterStrings(t).join(";")),Array.isArray(y)){var f=this;y.forEach(function(n){f._complexFilters("-map",n.replace(A.streamRegexp,"[$1]"))})}else typeof y=="string"&&this._complexFilters("-map",y.replace(A.streamRegexp,"[$1]"));return this}},J}function tt(A){throw new Error('Could not dynamically require "'+A+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var K,Ae;function nt(){if(Ae)return K;Ae=1;var A=V;return K=function(e){e.usingPreset=e.preset=function(t){if(typeof t=="function")t(this);else try{var y=A.join(this.options.presets,t),f=tt(y);if(typeof f.load=="function")f.load(this);else throw new Error("preset "+y+" has no load() function")}catch(n){throw new Error("preset "+y+" could not be loaded: "+n.message)}return this}},K}var ee={exports:{}},Oe;function te(){return Oe||(Oe=1,function(A){(function(){var e={},t,y;t=this,t!=null&&(y=t.async),e.noConflict=function(){return t.async=y,e};function f(r){var s=!1;return function(){if(s)throw new Error("Callback was already called.");s=!0,r.apply(t,arguments)}}var n=function(r,s){if(r.forEach)return r.forEach(s);for(var o=0;o<r.length;o+=1)s(r[o],o,r)},h=function(r,s){if(r.map)return r.map(s);var o=[];return n(r,function(l,p,w){o.push(s(l,p,w))}),o},u=function(r,s,o){return r.reduce?r.reduce(s,o):(n(r,function(l,p,w){o=s(o,l,p,w)}),o)},i=function(r){if(Object.keys)return Object.keys(r);var s=[];for(var o in r)r.hasOwnProperty(o)&&s.push(o);return s};typeof process>"u"||!process.nextTick?typeof setImmediate=="function"?(e.nextTick=function(r){setImmediate(r)},e.setImmediate=e.nextTick):(e.nextTick=function(r){setTimeout(r,0)},e.setImmediate=e.nextTick):(e.nextTick=process.nextTick,typeof setImmediate<"u"?e.setImmediate=function(r){setImmediate(r)}:e.setImmediate=e.nextTick),e.each=function(r,s,o){if(o=o||function(){},!r.length)return o();var l=0;n(r,function(p){s(p,f(function(w){w?(o(w),o=function(){}):(l+=1,l>=r.length&&o(null))}))})},e.forEach=e.each,e.eachSeries=function(r,s,o){if(o=o||function(){},!r.length)return o();var l=0,p=function(){s(r[l],function(w){w?(o(w),o=function(){}):(l+=1,l>=r.length?o(null):p())})};p()},e.forEachSeries=e.eachSeries,e.eachLimit=function(r,s,o,l){var p=c(s);p.apply(null,[r,o,l])},e.forEachLimit=e.eachLimit;var c=function(r){return function(s,o,l){if(l=l||function(){},!s.length||r<=0)return l();var p=0,w=0,I=0;(function P(){if(p>=s.length)return l();for(;I<r&&w<s.length;)w+=1,I+=1,o(s[w-1],function(T){T?(l(T),l=function(){}):(p+=1,I-=1,p>=s.length?l():P())})})()}},a=function(r){return function(){var s=Array.prototype.slice.call(arguments);return r.apply(null,[e.each].concat(s))}},d=function(r,s){return function(){var o=Array.prototype.slice.call(arguments);return s.apply(null,[c(r)].concat(o))}},v=function(r){return function(){var s=Array.prototype.slice.call(arguments);return r.apply(null,[e.eachSeries].concat(s))}},S=function(r,s,o,l){var p=[];s=h(s,function(w,I){return{index:I,value:w}}),r(s,function(w,I){o(w.value,function(P,T){p[w.index]=T,I(P)})},function(w){l(w,p)})};e.map=a(S),e.mapSeries=v(S),e.mapLimit=function(r,s,o,l){return F(s)(r,o,l)};var F=function(r){return d(r,S)};e.reduce=function(r,s,o,l){e.eachSeries(r,function(p,w){o(s,p,function(I,P){s=P,w(I)})},function(p){l(p,s)})},e.inject=e.reduce,e.foldl=e.reduce,e.reduceRight=function(r,s,o,l){var p=h(r,function(w){return w}).reverse();e.reduce(p,s,o,l)},e.foldr=e.reduceRight;var _=function(r,s,o,l){var p=[];s=h(s,function(w,I){return{index:I,value:w}}),r(s,function(w,I){o(w.value,function(P){P&&p.push(w),I()})},function(w){l(h(p.sort(function(I,P){return I.index-P.index}),function(I){return I.value}))})};e.filter=a(_),e.filterSeries=v(_),e.select=e.filter,e.selectSeries=e.filterSeries;var m=function(r,s,o,l){var p=[];s=h(s,function(w,I){return{index:I,value:w}}),r(s,function(w,I){o(w.value,function(P){P||p.push(w),I()})},function(w){l(h(p.sort(function(I,P){return I.index-P.index}),function(I){return I.value}))})};e.reject=a(m),e.rejectSeries=v(m);var b=function(r,s,o,l){r(s,function(p,w){o(p,function(I){I?(l(p),l=function(){}):w()})},function(p){l()})};e.detect=a(b),e.detectSeries=v(b),e.some=function(r,s,o){e.each(r,function(l,p){s(l,function(w){w&&(o(!0),o=function(){}),p()})},function(l){o(!1)})},e.any=e.some,e.every=function(r,s,o){e.each(r,function(l,p){s(l,function(w){w||(o(!1),o=function(){}),p()})},function(l){o(!0)})},e.all=e.every,e.sortBy=function(r,s,o){e.map(r,function(l,p){s(l,function(w,I){w?p(w):p(null,{value:l,criteria:I})})},function(l,p){if(l)return o(l);var w=function(I,P){var T=I.criteria,N=P.criteria;return T<N?-1:T>N?1:0};o(null,h(p.sort(w),function(I){return I.value}))})},e.auto=function(r,s){s=s||function(){};var o=i(r);if(!o.length)return s(null);var l={},p=[],w=function(T){p.unshift(T)},I=function(T){for(var N=0;N<p.length;N+=1)if(p[N]===T){p.splice(N,1);return}},P=function(){n(p.slice(0),function(T){T()})};w(function(){i(l).length===o.length&&(s(null,l),s=function(){})}),n(o,function(T){var N=r[T]instanceof Function?[r[T]]:r[T],L=function(B){var C=Array.prototype.slice.call(arguments,1);if(C.length<=1&&(C=C[0]),B){var he={};n(i(l),function(ke){he[ke]=l[ke]}),he[T]=C,s(B,he),s=function(){}}else l[T]=C,e.setImmediate(P)},St=N.slice(0,Math.abs(N.length-1))||[],qe=function(){return u(St,function(B,C){return B&&l.hasOwnProperty(C)},!0)&&!l.hasOwnProperty(T)};if(qe())N[N.length-1](L,l);else{var De=function(){qe()&&(I(De),N[N.length-1](L,l))};w(De)}})},e.waterfall=function(r,s){if(s=s||function(){},r.constructor!==Array){var o=new Error("First argument to waterfall must be an array of functions");return s(o)}if(!r.length)return s();var l=function(p){return function(w){if(w)s.apply(null,arguments),s=function(){};else{var I=Array.prototype.slice.call(arguments,1),P=p.next();P?I.push(l(P)):I.push(s),e.setImmediate(function(){p.apply(null,I)})}}};l(e.iterator(r))()};var O=function(r,s,o){if(o=o||function(){},s.constructor===Array)r.map(s,function(p,w){p&&p(function(I){var P=Array.prototype.slice.call(arguments,1);P.length<=1&&(P=P[0]),w.call(null,I,P)})},o);else{var l={};r.each(i(s),function(p,w){s[p](function(I){var P=Array.prototype.slice.call(arguments,1);P.length<=1&&(P=P[0]),l[p]=P,w(I)})},function(p){o(p,l)})}};e.parallel=function(r,s){O({map:e.map,each:e.each},r,s)},e.parallelLimit=function(r,s,o){O({map:F(s),each:c(s)},r,o)},e.series=function(r,s){if(s=s||function(){},r.constructor===Array)e.mapSeries(r,function(l,p){l&&l(function(w){var I=Array.prototype.slice.call(arguments,1);I.length<=1&&(I=I[0]),p.call(null,w,I)})},s);else{var o={};e.eachSeries(i(r),function(l,p){r[l](function(w){var I=Array.prototype.slice.call(arguments,1);I.length<=1&&(I=I[0]),o[l]=I,p(w)})},function(l){s(l,o)})}},e.iterator=function(r){var s=function(o){var l=function(){return r.length&&r[o].apply(null,arguments),l.next()};return l.next=function(){return o<r.length-1?s(o+1):null},l};return s(0)},e.apply=function(r){var s=Array.prototype.slice.call(arguments,1);return function(){return r.apply(null,s.concat(Array.prototype.slice.call(arguments)))}};var x=function(r,s,o,l){var p=[];r(s,function(w,I){o(w,function(P,T){p=p.concat(T||[]),I(P)})},function(w){l(w,p)})};e.concat=a(x),e.concatSeries=v(x),e.whilst=function(r,s,o){r()?s(function(l){if(l)return o(l);e.whilst(r,s,o)}):o()},e.doWhilst=function(r,s,o){r(function(l){if(l)return o(l);s()?e.doWhilst(r,s,o):o()})},e.until=function(r,s,o){r()?o():s(function(l){if(l)return o(l);e.until(r,s,o)})},e.doUntil=function(r,s,o){r(function(l){if(l)return o(l);s()?o():e.doUntil(r,s,o)})},e.queue=function(r,s){s===void 0&&(s=1);function o(w,I,P,T){I.constructor!==Array&&(I=[I]),n(I,function(N){var L={data:N,callback:typeof T=="function"?T:null};P?w.tasks.unshift(L):w.tasks.push(L),w.saturated&&w.tasks.length===s&&w.saturated(),e.setImmediate(w.process)})}var l=0,p={tasks:[],concurrency:s,saturated:null,empty:null,drain:null,push:function(w,I){o(p,w,!1,I)},unshift:function(w,I){o(p,w,!0,I)},process:function(){if(l<p.concurrency&&p.tasks.length){var w=p.tasks.shift();p.empty&&p.tasks.length===0&&p.empty(),l+=1;var I=function(){l-=1,w.callback&&w.callback.apply(w,arguments),p.drain&&p.tasks.length+l===0&&p.drain(),p.process()},P=f(I);r(w.data,P)}},length:function(){return p.tasks.length},running:function(){return l}};return p},e.cargo=function(r,s){var o=!1,l=[],p={tasks:l,payload:s,saturated:null,empty:null,drain:null,push:function(w,I){w.constructor!==Array&&(w=[w]),n(w,function(P){l.push({data:P,callback:typeof I=="function"?I:null}),p.saturated&&l.length===s&&p.saturated()}),e.setImmediate(p.process)},process:function w(){if(!o){if(l.length===0){p.drain&&p.drain();return}var I=typeof s=="number"?l.splice(0,s):l.splice(0),P=h(I,function(T){return T.data});p.empty&&p.empty(),o=!0,r(P,function(){o=!1;var T=arguments;n(I,function(N){N.callback&&N.callback.apply(null,T)}),w()})}},length:function(){return l.length},running:function(){return o}};return p};var E=function(r){return function(s){var o=Array.prototype.slice.call(arguments,1);s.apply(null,o.concat([function(l){var p=Array.prototype.slice.call(arguments,1);typeof console<"u"&&(l?console.error&&console.error(l):console[r]&&n(p,function(w){console[r](w)}))}]))}};e.log=E("log"),e.dir=E("dir"),e.memoize=function(r,s){var o={},l={};s=s||function(w){return w};var p=function(){var w=Array.prototype.slice.call(arguments),I=w.pop(),P=s.apply(null,w);P in o?I.apply(null,o[P]):P in l?l[P].push(I):(l[P]=[I],r.apply(null,w.concat([function(){o[P]=arguments;var T=l[P];delete l[P];for(var N=0,L=T.length;N<L;N++)T[N].apply(null,arguments)}])))};return p.memo=o,p.unmemoized=r,p},e.unmemoize=function(r){return function(){return(r.unmemoized||r).apply(null,arguments)}},e.times=function(r,s,o){for(var l=[],p=0;p<r;p++)l.push(p);return e.map(l,s,o)},e.timesSeries=function(r,s,o){for(var l=[],p=0;p<r;p++)l.push(p);return e.mapSeries(l,s,o)},e.compose=function(){var r=Array.prototype.reverse.call(arguments);return function(){var s=this,o=Array.prototype.slice.call(arguments),l=o.pop();e.reduce(r,o,function(p,w,I){w.apply(s,p.concat([function(){var P=arguments[0],T=Array.prototype.slice.call(arguments,1);I(P,T)}]))},function(p,w){l.apply(s,[p].concat(w))})}};var g=function(r,s){var o=function(){var p=this,w=Array.prototype.slice.call(arguments),I=w.pop();return r(s,function(P,T){P.apply(p,w.concat([T]))},I)};if(arguments.length>2){var l=Array.prototype.slice.call(arguments,2);return o.apply(this,l)}else return o};e.applyEach=a(g),e.applyEachSeries=v(g),e.forever=function(r,s){function o(l){if(l){if(s)return s(l);throw l}r(o)}o()},A.exports?A.exports=e:t.async=e})()}(ee)),ee.exports}var ne,Ie;function rt(){if(Ie)return ne;Ie=1;var A=V.spawn,e=te(),t=M();function y(f){f._inputs[0].isStream||f.ffprobe(0,function(h,u){f._ffprobeData=u})}return ne=function(f){f._spawnFfmpeg=function(n,h,u,i){typeof h=="function"&&(i=u,u=h,h={}),typeof i>"u"&&(i=u,u=function(){});var c="stdoutLines"in h?h.stdoutLines:this.options.stdoutLines;this._getFfmpegPath(function(a,d){if(a)return i(a);if(!d||d.length===0)return i(new Error("Cannot find ffmpeg"));h.niceness&&h.niceness!==0&&!t.isWindows&&(n.unshift("-n",h.niceness,d),d="nice");var v=t.linesRing(c),S=!1,F=t.linesRing(c),_=!1,m=A(d,n,h);m.stderr&&m.stderr.setEncoding("utf8"),m.on("error",function(E){i(E)});var b=null;function O(E){E&&(b=E),x&&(S||!h.captureStdout)&&_&&i(b,v,F)}var x=!1;m.on("exit",function(E,g){x=!0,g?O(new Error("ffmpeg was killed with signal "+g)):E?O(new Error("ffmpeg exited with code "+E)):O()}),h.captureStdout&&(m.stdout.on("data",function(E){v.append(E)}),m.stdout.on("close",function(){v.close(),S=!0,O()})),m.stderr.on("data",function(E){F.append(E)}),m.stderr.on("close",function(){F.close(),_=!0,O()}),u(m,v,F)})},f._getArguments=function(){var n=this._complexFilters.get(),h=this._outputs.some(function(u){return u.isFile});return[].concat(this._inputs.reduce(function(u,i){var c=typeof i.source=="string"?i.source:"pipe:0";return u.concat(i.options.get(),["-i",c])},[]),this._global.get(),h?["-y"]:[],n,this._outputs.reduce(function(u,i){var c=t.makeFilterStrings(i.sizeFilters.get()),a=i.audioFilters.get(),d=i.videoFilters.get().concat(c),v;return i.target?typeof i.target=="string"?v=[i.target]:v=["pipe:1"]:v=[],u.concat(i.audio.get(),a.length?["-filter:a",a.join(",")]:[],i.video.get(),d.length?["-filter:v",d.join(",")]:[],i.options.get(),v)},[]))},f._prepare=function(n,h){var u=this;e.waterfall([function(i){u._checkCapabilities(i)},function(i){if(!h)return i();u.ffprobe(0,function(c,a){c||(u._ffprobeData=a),i()})},function(i){var c=u._outputs.some(function(a){return a.flags.flvmeta&&!a.isFile&&(u.logger.warn("Updating flv metadata is only supported for files"),a.flags.flvmeta=!1),a.flags.flvmeta});c?u._getFlvtoolPath(function(a){i(a)}):i()},function(i){var c;try{c=u._getArguments()}catch(a){return i(a)}i(null,c)},function(i,c){u.availableEncoders(function(a,d){for(var v=0;v<i.length;v++)(i[v]==="-acodec"||i[v]==="-vcodec")&&(v++,i[v]in d&&d[i[v]].experimental&&(i.splice(v+1,0,"-strict","experimental"),v+=2));c(null,i)})}],n),h||(this.listeners("progress").length>0?y(this):this.once("newListener",function(i){i==="progress"&&y(this)}))},f.exec=f.execute=f.run=function(){var n=this,h=this._outputs.some(function(d){return"target"in d});if(!h)throw new Error("No output specified");var u=this._outputs.filter(function(d){return typeof d.target!="string"})[0],i=this._inputs.filter(function(d){return typeof d.source!="string"})[0],c=!1;function a(d,v,S){c||(c=!0,d?n.emit("error",d,v,S):n.emit("end",v,S))}return n._prepare(function(d,v){if(d)return a(d);n._spawnFfmpeg(v,{captureStdout:!u,niceness:n.options.niceness,cwd:n.options.cwd,windowsHide:!0},function(F,_,m){if(n.ffmpegProc=F,n.emit("start","ffmpeg "+v.join(" ")),i&&(i.source.on("error",function(x){var E=new Error("Input stream error: "+x.message);E.inputStreamError=x,a(E),F.kill()}),i.source.resume(),i.source.pipe(F.stdin),F.stdin.on("error",function(){})),n.options.timeout&&(n.processTimer=setTimeout(function(){var x="process ran into a timeout ("+n.options.timeout+"s)";a(new Error(x),_.get(),m.get()),F.kill()},n.options.timeout*1e3)),u&&(F.stdout.pipe(u.target,u.pipeopts),u.target.on("close",function(){n.logger.debug("Output stream closed, scheduling kill for ffmpeg process"),setTimeout(function(){a(new Error("Output stream closed")),F.kill()},20)}),u.target.on("error",function(x){n.logger.debug("Output stream error, killing ffmpeg process");var E=new Error("Output stream error: "+x.message);E.outputStreamError=x,a(E,_.get(),m.get()),F.kill("SIGKILL")})),m){if(n.listeners("stderr").length&&m.callback(function(x){n.emit("stderr",x)}),n.listeners("codecData").length){var b=!1,O={};m.callback(function(x){b||(b=t.extractCodecData(n,x,O))})}n.listeners("progress").length&&m.callback(function(x){t.extractProgress(n,x)})}},function(F,_,m){if(clearTimeout(n.processTimer),delete n.ffmpegProc,F)F.message.match(/ffmpeg exited with code/)&&(F.message+=": "+t.extractError(m.get())),a(F,_.get(),m.get());else{var b=n._outputs.filter(function(O){return O.flags.flvmeta});b.length?n._getFlvtoolPath(function(O,x){if(O)return a(O);e.each(b,function(E,g){A(x,["-U",E.target],{windowsHide:!0}).on("error",function(r){g(new Error("Error running "+x+" on "+E.target+": "+r.message))}).on("exit",function(r,s){r!==0||s?g(new Error(x+" "+(s?"received signal "+s:"exited with code "+r))+" when running on "+E.target):g()})},function(E){E?a(E):a(null,_.get(),m.get())})}):a(null,_.get(),m.get())}})}),this},f.renice=function(n){if(!t.isWindows&&(n=n||0,(n<-20||n>20)&&this.logger.warn("Invalid niceness value: "+n+", must be between -20 and 20"),n=Math.min(20,Math.max(-20,n)),this.options.niceness=n,this.ffmpegProc)){var h=this.logger,u=this.ffmpegProc.pid,i=A("renice",[n,"-p",u],{windowsHide:!0});i.on("error",function(c){h.warn("could not renice process "+u+": "+c.message)}),i.on("exit",function(c,a){a?h.warn("could not renice process "+u+": renice was killed by signal "+a):c?h.warn("could not renice process "+u+": renice exited with "+c):h.info("successfully reniced process "+u+" to "+n+" niceness")})}return this},f.kill=function(n){return this.ffmpegProc?this.ffmpegProc.kill(n||"SIGKILL"):this.logger.warn("No running ffmpeg process, cannot send signal"),this}},ne}var re,be;function it(){if(be)return re;be=1;var A=V,e=V,t=te(),y=M(),f=/^\s*([D ])([E ])([VAS])([S ])([D ])([T ]) ([^ ]+) +(.*)$/,n=/^\s*([D\.])([E\.])([VAS])([I\.])([L\.])([S\.]) ([^ ]+) +(.*)$/,h=/\(encoders:([^\)]+)\)/,u=/\(decoders:([^\)]+)\)/,i=/^\s*([VAS\.])([F\.])([S\.])([X\.])([B\.])([D\.]) ([^ ]+) +(.*)$/,c=/^\s*([D ])([E ])\s+([^ ]+)\s+(.*)$/,a=/\r\n|\r|\n/,d=/^(?: [T\.][S\.][C\.] )?([^ ]+) +(AA?|VV?|\|)->(AA?|VV?|\|) +(.*)$/,v={};return re=function(S){S.setFfmpegPath=function(F){return v.ffmpegPath=F,this},S.setFfprobePath=function(F){return v.ffprobePath=F,this},S.setFlvtoolPath=function(F){return v.flvtoolPath=F,this},S._forgetPaths=function(){delete v.ffmpegPath,delete v.ffprobePath,delete v.flvtoolPath},S._getFfmpegPath=function(F){if("ffmpegPath"in v)return F(null,v.ffmpegPath);t.waterfall([function(_){process.env.FFMPEG_PATH?A.exists(process.env.FFMPEG_PATH,function(m){m?_(null,process.env.FFMPEG_PATH):_(null,"")}):_(null,"")},function(_,m){if(_.length)return m(null,_);y.which("ffmpeg",function(b,O){m(b,O)})}],function(_,m){_?F(_):F(null,v.ffmpegPath=m||"")})},S._getFfprobePath=function(F){var _=this;if("ffprobePath"in v)return F(null,v.ffprobePath);t.waterfall([function(m){process.env.FFPROBE_PATH?A.exists(process.env.FFPROBE_PATH,function(b){m(null,b?process.env.FFPROBE_PATH:"")}):m(null,"")},function(m,b){if(m.length)return b(null,m);y.which("ffprobe",function(O,x){b(O,x)})},function(m,b){if(m.length)return b(null,m);_._getFfmpegPath(function(O,x){if(O)b(O);else if(x.length){var E=y.isWindows?"ffprobe.exe":"ffprobe",g=e.join(e.dirname(x),E);A.exists(g,function(r){b(null,r?g:"")})}else b(null,"")})}],function(m,b){m?F(m):F(null,v.ffprobePath=b||"")})},S._getFlvtoolPath=function(F){if("flvtoolPath"in v)return F(null,v.flvtoolPath);t.waterfall([function(_){process.env.FLVMETA_PATH?A.exists(process.env.FLVMETA_PATH,function(m){_(null,m?process.env.FLVMETA_PATH:"")}):_(null,"")},function(_,m){if(_.length)return m(null,_);process.env.FLVTOOL2_PATH?A.exists(process.env.FLVTOOL2_PATH,function(b){m(null,b?process.env.FLVTOOL2_PATH:"")}):m(null,"")},function(_,m){if(_.length)return m(null,_);y.which("flvmeta",function(b,O){m(b,O)})},function(_,m){if(_.length)return m(null,_);y.which("flvtool2",function(b,O){m(b,O)})}],function(_,m){_?F(_):F(null,v.flvtoolPath=m||"")})},S.availableFilters=S.getAvailableFilters=function(F){if("filters"in v)return F(null,v.filters);this._spawnFfmpeg(["-filters"],{captureStdout:!0,stdoutLines:0},function(_,m){if(_)return F(_);var b=m.get(),O=b.split(`
`),x={},E={A:"audio",V:"video","|":"none"};O.forEach(function(g){var r=g.match(d);r&&(x[r[1]]={description:r[4],input:E[r[2].charAt(0)],multipleInputs:r[2].length>1,output:E[r[3].charAt(0)],multipleOutputs:r[3].length>1})}),F(null,v.filters=x)})},S.availableCodecs=S.getAvailableCodecs=function(F){if("codecs"in v)return F(null,v.codecs);this._spawnFfmpeg(["-codecs"],{captureStdout:!0,stdoutLines:0},function(_,m){if(_)return F(_);var b=m.get(),O=b.split(a),x={};O.forEach(function(E){var g=E.match(f);if(g&&g[7]!=="="&&(x[g[7]]={type:{V:"video",A:"audio",S:"subtitle"}[g[3]],description:g[8],canDecode:g[1]==="D",canEncode:g[2]==="E",drawHorizBand:g[4]==="S",directRendering:g[5]==="D",weirdFrameTruncation:g[6]==="T"}),g=E.match(n),g&&g[7]!=="="){var r=x[g[7]]={type:{V:"video",A:"audio",S:"subtitle"}[g[3]],description:g[8],canDecode:g[1]==="D",canEncode:g[2]==="E",intraFrameOnly:g[4]==="I",isLossy:g[5]==="L",isLossless:g[6]==="S"},s=r.description.match(h);s=s?s[1].trim().split(" "):[];var o=r.description.match(u);if(o=o?o[1].trim().split(" "):[],s.length||o.length){var l={};y.copy(r,l),delete l.canEncode,delete l.canDecode,s.forEach(function(p){x[p]={},y.copy(l,x[p]),x[p].canEncode=!0}),o.forEach(function(p){p in x||(x[p]={},y.copy(l,x[p])),x[p].canDecode=!0})}}}),F(null,v.codecs=x)})},S.availableEncoders=S.getAvailableEncoders=function(F){if("encoders"in v)return F(null,v.encoders);this._spawnFfmpeg(["-encoders"],{captureStdout:!0,stdoutLines:0},function(_,m){if(_)return F(_);var b=m.get(),O=b.split(a),x={};O.forEach(function(E){var g=E.match(i);g&&g[7]!=="="&&(x[g[7]]={type:{V:"video",A:"audio",S:"subtitle"}[g[1]],description:g[8],frameMT:g[2]==="F",sliceMT:g[3]==="S",experimental:g[4]==="X",drawHorizBand:g[5]==="B",directRendering:g[6]==="D"})}),F(null,v.encoders=x)})},S.availableFormats=S.getAvailableFormats=function(F){if("formats"in v)return F(null,v.formats);this._spawnFfmpeg(["-formats"],{captureStdout:!0,stdoutLines:0},function(_,m){if(_)return F(_);var b=m.get(),O=b.split(a),x={};O.forEach(function(E){var g=E.match(c);g&&g[3].split(",").forEach(function(r){r in x||(x[r]={description:g[4],canDemux:!1,canMux:!1}),g[1]==="D"&&(x[r].canDemux=!0),g[2]==="E"&&(x[r].canMux=!0)})}),F(null,v.formats=x)})},S._checkCapabilities=function(F){var _=this;t.waterfall([function(m){_.availableFormats(m)},function(m,b){var O;if(O=_._outputs.reduce(function(x,E){var g=E.options.find("-f",1);return g&&(!(g[0]in m)||!m[g[0]].canMux)&&x.push(g),x},[]),O.length===1)return b(new Error("Output format "+O[0]+" is not available"));if(O.length>1)return b(new Error("Output formats "+O.join(", ")+" are not available"));if(O=_._inputs.reduce(function(x,E){var g=E.options.find("-f",1);return g&&(!(g[0]in m)||!m[g[0]].canDemux)&&x.push(g[0]),x},[]),O.length===1)return b(new Error("Input format "+O[0]+" is not available"));if(O.length>1)return b(new Error("Input formats "+O.join(", ")+" are not available"));b()},function(m){_.availableEncoders(m)},function(m,b){var O;if(O=_._outputs.reduce(function(x,E){var g=E.audio.find("-acodec",1);return g&&g[0]!=="copy"&&(!(g[0]in m)||m[g[0]].type!=="audio")&&x.push(g[0]),x},[]),O.length===1)return b(new Error("Audio codec "+O[0]+" is not available"));if(O.length>1)return b(new Error("Audio codecs "+O.join(", ")+" are not available"));if(O=_._outputs.reduce(function(x,E){var g=E.video.find("-vcodec",1);return g&&g[0]!=="copy"&&(!(g[0]in m)||m[g[0]].type!=="video")&&x.push(g[0]),x},[]),O.length===1)return b(new Error("Video codec "+O[0]+" is not available"));if(O.length>1)return b(new Error("Video codecs "+O.join(", ")+" are not available"));b()}],F)}},re}var ie,Se;function ut(){if(Se)return ie;Se=1;var A=V.spawn;function e(f){return f.match(/^TAG:/)}function t(f){return f.match(/^DISPOSITION:/)}function y(f){var n=f.split(/\r\n|\r|\n/);n=n.filter(function(d){return d.length>0});var h={streams:[],format:{},chapters:[]};function u(d){for(var v={},S=n.shift();typeof S<"u";){if(S.toLowerCase()=="[/"+d+"]")return v;if(S.match(/^\[/)){S=n.shift();continue}var F=S.match(/^([^=]+)=(.*)$/);F&&(!F[1].match(/^TAG:/)&&F[2].match(/^[0-9]+(\.[0-9]+)?$/)?v[F[1]]=Number(F[2]):v[F[1]]=F[2]),S=n.shift()}return v}for(var i=n.shift();typeof i<"u";){if(i.match(/^\[stream/i)){var c=u("stream");h.streams.push(c)}else if(i.match(/^\[chapter/i)){var a=u("chapter");h.chapters.push(a)}else i.toLowerCase()==="[format]"&&(h.format=u("format"));i=n.shift()}return h}return ie=function(f){f.ffprobe=function(){var n,h=null,u=[],i,i=arguments[arguments.length-1],c=!1;function a(d,v){c||(c=!0,i(d,v))}switch(arguments.length){case 3:h=arguments[0],u=arguments[1];break;case 2:typeof arguments[0]=="number"?h=arguments[0]:Array.isArray(arguments[0])&&(u=arguments[0]);break}if(h===null){if(!this._currentInput)return a(new Error("No input specified"));n=this._currentInput}else if(n=this._inputs[h],!n)return a(new Error("Invalid input index"));this._getFfprobePath(function(d,v){if(d)return a(d);if(!v)return a(new Error("Cannot find ffprobe"));var S="",F=!1,_="",m=!1,b=n.isStream?"pipe:0":n.source,O=A(v,["-show_streams","-show_format"].concat(u,b),{windowsHide:!0});n.isStream&&(O.stdin.on("error",function(r){["ECONNRESET","EPIPE","EOF"].indexOf(r.code)>=0||a(r)}),O.stdin.on("close",function(){n.source.pause(),n.source.unpipe(O.stdin)}),n.source.pipe(O.stdin)),O.on("error",i);var x=null;function E(r){if(r&&(x=r),g&&F&&m){if(x)return _&&(x.message+=`
`+_),a(x);var s=y(S);[s.format].concat(s.streams).forEach(function(o){if(o){var l=Object.keys(o).filter(e);l.length&&(o.tags=o.tags||{},l.forEach(function(w){o.tags[w.substr(4)]=o[w],delete o[w]}));var p=Object.keys(o).filter(t);p.length&&(o.disposition=o.disposition||{},p.forEach(function(w){o.disposition[w.substr(12)]=o[w],delete o[w]}))}}),a(null,s)}}var g=!1;O.on("exit",function(r,s){g=!0,r?E(new Error("ffprobe exited with code "+r)):s?E(new Error("ffprobe was killed with signal "+s)):E()}),O.stdout.on("data",function(r){S+=r}),O.stdout.on("close",function(){F=!0,E()}),O.stderr.on("data",function(r){_+=r}),O.stderr.on("close",function(){m=!0,E()})})}},ie}var ue,Pe;function at(){if(Pe)return ue;Pe=1;var A=V,e=V,t=V.PassThrough,y=te(),f=M();return ue=function(h){h.saveToFile=h.save=function(u){return this.output(u).run(),this},h.writeToStream=h.pipe=h.stream=function(u,i){if(u&&!("writable"in u)&&(i=u,u=void 0),!u){if(process.version.match(/v0\.8\./))throw new Error("PassThrough stream is not supported on node v0.8");u=new t}return this.output(u,i).run(),u},h.takeScreenshots=h.thumbnail=h.thumbnails=h.screenshot=h.screenshots=function(u,i){var c=this,a=this._currentInput.source;if(u=u||{count:1},typeof u=="number"&&(u={count:u}),"folder"in u||(u.folder=i||"."),"timestamps"in u&&(u.timemarks=u.timestamps),!("timemarks"in u)){if(!u.count)throw new Error("Cannot take screenshots: neither a count nor a timemark list are specified");var d=100/(1+u.count);u.timemarks=[];for(var v=0;v<u.count;v++)u.timemarks.push(d*(v+1)+"%")}if("size"in u){var S=u.size.match(/^(\d+)x(\d+)$/),F=u.size.match(/^(\d+)x\?$/),_=u.size.match(/^\?x(\d+)$/),m=u.size.match(/^(\d+)%$/);if(!S&&!F&&!_&&!m)throw new Error("Invalid size parameter: "+u.size)}var b;function O(x){b?x(null,b):c.ffprobe(function(E,g){b=g,x(E,g)})}return y.waterfall([function(E){if(u.timemarks.some(function(g){return(""+g).match(/^[\d.]+%$/)})){if(typeof a!="string")return E(new Error("Cannot compute screenshot timemarks with an input stream, please specify fixed timemarks"));O(function(g,r){if(g)E(g);else{var s=r.streams.reduce(function(l,p){return p.codec_type==="video"&&p.width*p.height>l.width*l.height?p:l},{width:0,height:0});if(s.width===0)return E(new Error("No video stream in input, cannot take screenshots"));var o=Number(s.duration);if(isNaN(o)&&(o=Number(r.format.duration)),isNaN(o))return E(new Error("Could not get input duration, please specify fixed timemarks"));u.timemarks=u.timemarks.map(function(l){return(""+l).match(/^([\d.]+)%$/)?o*parseFloat(l)/100:l}),E()}})}else E()},function(E){u.timemarks=u.timemarks.map(function(g){return f.timemarkToSeconds(g)}).sort(function(g,r){return g-r}),E()},function(E){var g=u.filename||"tn.png";if(g.indexOf(".")===-1&&(g+=".png"),u.timemarks.length>1&&!g.match(/%(s|0*i)/)){var r=e.extname(g);g=e.join(e.dirname(g),e.basename(g,r)+"_%i"+r)}E(null,g)},function(E,g){if(E.match(/%[bf]/)){if(typeof a!="string")return g(new Error("Cannot replace %f or %b when using an input stream"));E=E.replace(/%f/g,e.basename(a)).replace(/%b/g,e.basename(a,e.extname(a)))}g(null,E)},function(E,g){if(E.match(/%[whr]/)){if(S)return g(null,E,S[1],S[2]);O(function(r,s){if(r)return g(new Error("Could not determine video resolution to replace %w, %h or %r"));var o=s.streams.reduce(function(w,I){return I.codec_type==="video"&&I.width*I.height>w.width*w.height?I:w},{width:0,height:0});if(o.width===0)return g(new Error("No video stream in input, cannot replace %w, %h or %r"));var l=o.width,p=o.height;F?(p=p*Number(F[1])/l,l=Number(F[1])):_?(l=l*Number(_[1])/p,p=Number(_[1])):m&&(l=l*Number(m[1])/100,p=p*Number(m[1])/100),g(null,E,Math.round(l/2)*2,Math.round(p/2)*2)})}else g(null,E,-1,-1)},function(E,g,r,s){E=E.replace(/%r/g,"%wx%h").replace(/%w/g,g).replace(/%h/g,r),s(null,E)},function(E,g){var r=u.timemarks.map(function(s,o){return E.replace(/%s/g,f.timemarkToSeconds(s)).replace(/%(0*)i/g,function(l,p){var w=""+(o+1);return p.substr(0,Math.max(0,p.length+1-w.length))+w})});c.emit("filenames",r),g(null,r)},function(E,g){A.exists(u.folder,function(r){r?g(null,E):A.mkdir(u.folder,function(s){s?g(s):g(null,E)})})}],function(E,g){if(E)return c.emit("error",E);var r=u.timemarks.length,s,o=[s={filter:"split",options:r,outputs:[]}];if("size"in u){c.size(u.size);var l=c._currentOutput.sizeFilters.get().map(function(P,T){return T>0&&(P.inputs="size"+(T-1)),P.outputs="size"+T,P});s.inputs="size"+(l.length-1),o=l.concat(o),c._currentOutput.sizeFilters.clear()}for(var p=0,w=0;w<r;w++){var I="screen"+w;s.outputs.push(I),w===0&&(p=u.timemarks[w],c.seekInput(p)),c.output(e.join(u.folder,g[w])).frames(1).map(I),w>0&&c.seek(u.timemarks[w]-p)}c.complexFilter(o),c.run()}),this},h.mergeToFile=h.concatenate=h.concat=function(u,i){var c=this._inputs.filter(function(d){return!d.isStream})[0],a=this;return this.ffprobe(this._inputs.indexOf(c),function(d,v){if(d)return a.emit("error",d);var S=v.streams.some(function(_){return _.codec_type==="audio"}),F=v.streams.some(function(_){return _.codec_type==="video"});a.output(u,i).complexFilter({filter:"concat",options:{n:a._inputs.length,v:F?1:0,a:S?1:0}}).run()}),this}},ue}var ae,Te;function st(){if(Te)return ae;Te=1;var A=V,e=V,t=V.EventEmitter,y=M();function f(n,h){if(!(this instanceof f))return new f(n,h);t.call(this),typeof n=="object"&&!("readable"in n)?h=n:(h=h||{},h.source=n),this._inputs=[],h.source&&this.input(h.source),this._outputs=[],this.output();var u=this;["_global","_complexFilters"].forEach(function(i){u[i]=y.args()}),h.stdoutLines="stdoutLines"in h?h.stdoutLines:100,h.presets=h.presets||h.preset||A.join(__dirname,"presets"),h.niceness=h.niceness||h.priority||0,this.options=h,this.logger=h.logger||{debug:function(){},info:function(){},warn:function(){},error:function(){}}}return e.inherits(f,t),ae=f,f.prototype.clone=function(){var n=new f,h=this;return n.options=this.options,n.logger=this.logger,n._inputs=this._inputs.map(function(u){return{source:u.source,options:u.options.clone()}}),"target"in this._outputs[0]?(n._outputs=[],n.output()):(n._outputs=[n._currentOutput={flags:{}}],["audio","audioFilters","video","videoFilters","sizeFilters","options"].forEach(function(u){n._currentOutput[u]=h._currentOutput[u].clone()}),this._currentOutput.sizeData&&(n._currentOutput.sizeData={},y.copy(this._currentOutput.sizeData,n._currentOutput.sizeData)),y.copy(this._currentOutput.flags,n._currentOutput.flags)),["_global","_complexFilters"].forEach(function(u){n[u]=h[u].clone()}),n},Qe()(f.prototype),Ze()(f.prototype),Ye()(f.prototype),Je()(f.prototype),Ke()(f.prototype),et()(f.prototype),nt()(f.prototype),rt()(f.prototype),it()(f.prototype),f.setFfmpegPath=function(n){new f().setFfmpegPath(n)},f.setFfprobePath=function(n){new f().setFfprobePath(n)},f.setFlvtoolPath=function(n){new f().setFlvtoolPath(n)},f.availableFilters=f.getAvailableFilters=function(n){new f().availableFilters(n)},f.availableCodecs=f.getAvailableCodecs=function(n){new f().availableCodecs(n)},f.availableFormats=f.getAvailableFormats=function(n){new f().availableFormats(n)},f.availableEncoders=f.getAvailableEncoders=function(n){new f().availableEncoders(n)},ut()(f.prototype),f.ffprobe=function(n){var h=new f(n);h.ffprobe.apply(h,Array.prototype.slice.call(arguments,1))},at()(f.prototype),ae}var se,Ne;function ot(){return Ne||(Ne=1,se=st()),se}var Ve=ot();const ze=z({__proto__:null,default:je(Ve)},[Ve]);var D={exports:{}},oe,Re;function fe(){return Re||(Re=1,oe={DEFAULT_INITIAL_SIZE:8*1024,DEFAULT_INCREMENT_AMOUNT:8*1024,DEFAULT_FREQUENCY:1,DEFAULT_CHUNK_SIZE:1024}),oe}var le={exports:{}},Me;function ft(){if(Me)return le.exports;Me=1;var A=V,e=fe(),t=V,y=le.exports=function(f){var n=this;f=f||{},A.Readable.call(this,f),this.stopped=!1;var h=f.hasOwnProperty("frequency")?f.frequency:e.DEFAULT_FREQUENCY,u=f.chunkSize||e.DEFAULT_CHUNK_SIZE,i=f.initialSize||e.DEFAULT_INITIAL_SIZE,c=f.incrementAmount||e.DEFAULT_INCREMENT_AMOUNT,a=0,d=new Buffer(i),v=!1,S=function(){var m=Math.min(u,a),b=!1;if(m>0){var O=null;O=new Buffer(m),d.copy(O,0,0,m),b=n.push(O)!==!1,v=b,d.copy(d,0,m,a),a-=m}a===0&&n.stopped&&n.push(null),b?S.timeout=setTimeout(S,h):S.timeout=null};this.stop=function(){if(this.stopped)throw new Error("stop() called on already stopped ReadableStreamBuffer");this.stopped=!0,a===0&&this.push(null)},this.size=function(){return a},this.maxSize=function(){return d.length};var F=function(m){if(d.length-a<m){var b=Math.ceil((m-(d.length-a))/c),O=new Buffer(d.length+c*b);d.copy(O,0,0,a),d=O}},_=function(){!S.timeout&&v&&(S.timeout=setTimeout(S,h))};this.put=function(m,b){if(n.stopped)throw new Error("Tried to write data to a stopped ReadableStreamBuffer");if(Buffer.isBuffer(m))F(m.length),m.copy(d,a,0),a+=m.length;else{m=m+"";var O=Buffer.byteLength(m);F(O),d.write(m,a,b||"utf8"),a+=O}_()},this._read=function(){v=!0,_()}};return t.inherits(y,A.Readable),le.exports}var ce={exports:{}},Le;function lt(){if(Le)return ce.exports;Le=1;var A=V,e=V,t=fe(),y=ce.exports=function(f){f=f||{},f.decodeStrings=!0,e.Writable.call(this,f);var n=f.initialSize||t.DEFAULT_INITIAL_SIZE,h=f.incrementAmount||t.DEFAULT_INCREMENT_AMOUNT,u=new Buffer(n),i=0;this.size=function(){return i},this.maxSize=function(){return u.length},this.getContents=function(a){if(!i)return!1;var d=new Buffer(Math.min(a||i,i));return u.copy(d,0,0,d.length),d.length<i&&u.copy(u,0,d.length),i-=d.length,d},this.getContentsAsString=function(a,d){if(!i)return!1;var v=u.toString(a||"utf8",0,Math.min(d||i,i)),S=Buffer.byteLength(v);return S<i&&u.copy(u,0,S),i-=S,v};var c=function(a){if(u.length-i<a){var d=Math.ceil((a-(u.length-i))/h),v=new Buffer(u.length+h*d);u.copy(v,0,0,i),u=v}};this._write=function(a,d,v){c(a.length),a.copy(u,i,0),i+=a.length,v()}};return A.inherits(y,e.Writable),ce.exports}var Ce;function ct(){return Ce||(Ce=1,D.exports=fe(),D.exports.ReadableStreamBuffer=ft(),D.exports.WritableStreamBuffer=lt()),D.exports}var ht=ct();class pt{constructor(){k(this,"getResolutionQuality",(e,t)=>e>=3840&&t>=2160?"4K":e>=2048&&t>=1080?"2K":e>=1920&&t>=1080?"Full HD":e>=1280&&t>=720?"HD":"SD");k(this,"generateThumbnail",async e=>{const t=(void 0)(__dirname,"tmp"),y=(void 0)(t,`temp_${Date.now()}`),f=(void 0)(t,`screenshot_${Date.now()}.png`);return await(void 0)(t,{recursive:!0}),await(void 0)(y,e.buffer),new Promise((n,h)=>{ze(y).on("error",async u=>{console.error("Error generating screenshot:",u),h(u)}).on("end",async()=>{try{const u=await(void 0)(f);await(void 0)(y).catch(()=>{}),await(void 0)(f).catch(()=>{}),n(u)}catch(u){h(u)}}).screenshots({timestamps:["50%"],filename:(void 0)(f),folder:t})})});k(this,"analyzeMediaBuffer",async e=>new Promise((t,y)=>{const f=new ht.ReadableStreamBuffer({frequency:10,chunkSize:2048});f.put(e.buffer),f.stop(),ze(f).ffprobe(async(n,h)=>{if(n){y(n);return}const u=h.streams.find(c=>c.codec_type==="video"||c.codec_type==="image");if(!u){y(new Error("No video or image stream found"));return}const i={type:u.codec_type+"",resolution:{width:u.width,height:u.height},format:h.format.format_name+""};if(e.mimetype.startsWith("video")){i.durationInSeconds=u.duration?Math.floor(parseFloat(u.duration)):void 0,i.bitRate=Math.floor(parseInt(u.bit_rate+"")/1024),i.resolution.quality=this.getResolutionQuality(parseInt(u.width+""),parseInt(u.height+""));const c=await this.generateThumbnail(e);i.thumbnail=c}t(i)})}))}}class dt{constructor(e){this.file=e}async validate(){const t=await new pt().analyzeMediaBuffer(this.file);return console.log(t),!0}}class vt{async validate(e,t){if((e==="image"||e==="video")&&!this.isMulterFile(t))throw new Error("Invalid type for backend validation.");if(e==="vast"&&!(t instanceof String))throw new Error("Invalid type for backend validation.");switch(e){case"image":return await this.validateImage(t);case"video":return await this.validateVideo(t);case"vast":return await this.validateVast(t)}}isMulterFile(e){return"buffer"in e&&"originalname"in e&&"mimetype"in e&&"size"in e}async validateVideo(e){return await new dt(e).validate()}async validateImage(e){return await new q(e).validate()}async validateVast(e){return await new Be(e).validate()}}const mt=50,gt=2e3,wt=50,yt=2e3,_t=["JPEG","JPG","PNG","GIF"],Et=1e8;function Ft(A){return(A.includes("/")?A.split("/")[1]:A).toUpperCase()}class xt{constructor(e){this.file=e}async validate(){console.log(this.file);const e=await this.getImageFromFile(this.file);return console.log(e.width,e.height),!0}validateSize(){return this.file.size>Et}async validateResolution(){const e=await this.getImageFromFile(this.file);return e.width>yt||e.width<wt||e.height>gt||e.height<mt}validateType(){return _t.includes(Ft(this.file.type))}async getImageFromFile(e){return new Promise((t,y)=>{e.arrayBuffer().then(f=>{const n=new Blob([f],{type:e.type}),h=URL.createObjectURL(n),u=new Image;u.src=h,u.onload=()=>t(u),u.onerror=y})})}}class At{constructor(e){this.file=e}async validate(){return console.log(this.file),!0}}class Ot{constructor(e){this.file=e}async validate(){return console.log(this.file),!0}}class It{async validate(e,t){if((e==="image"||e==="video")&&!this.isFile(t))throw new Error("Invalid type for backend validation.");if(e==="vast"&&!(t instanceof String))throw new Error("Invalid type for backend validation.");switch(e){case"image":return await this.validateImage(t);case"video":return await this.validateVideo(t);case"vast":return await this.validateVast(t)}}isFile(e){return"fileBits"in e&&"fileName"in e&&"options"in e}async validateVideo(e){return await new Ot(e).validate()}async validateImage(e){return await new xt(e).validate()}async validateVast(e){return await new At(e).validate()}}class bt{constructor(e){k(this,"validatorStrategy");this.validatorStrategy=e==="backend"?new vt:new It}validate(e,t){this.validatorStrategy.validate(e,t)}}R.CreativeValidator=bt,Object.defineProperty(R,Symbol.toStringTag,{value:"Module"})});
